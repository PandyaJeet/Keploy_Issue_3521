version: "3.8"
services:
    app:
        build: .
        depends_on:
            keploy-agent:
                condition: service_healthy
            db:
                condition: service_started
        environment:
            - DB_HOST=db
        pid: service:keploy-agent
        network_mode: service:keploy-agent
    db:
        image: postgres:15
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: keploy_db
        ports:
            - "5432:5432"
        networks:
            - keploy-net
    keploy-agent:
        image: ghcr.io/keploy/keploy:v3.2.3
        container_name: keploy-v3-e0e5
        privileged: true
        environment:
            - BINARY_TO_DOCKER=true
        ports:
            - "46321:46321"
            - "16789:16789"
            - "8080:8080"
        networks:
            keploy-net:
                aliases:
                    - app
        volumes:
            - /sys/fs/cgroup:/sys/fs/cgroup
            - /sys/kernel/debug:/sys/kernel/debug
            - /sys/fs/bpf:/sys/fs/bpf
        command:
            - --port
            - "46321"
            - --proxy-port
            - "16789"
            - --dns-port
            - "26789"
            - --client-pid
            - "6809"
            - --mode
            - record
            - --is-docker
            - --config-path
            - /workspaces/Keploy_Issue_3521/keploy-cpp-quickstart
            - --build-delay
            - "30"
        healthcheck:
            test:
                - CMD-SHELL
                - cat /tmp/agent.ready
            interval: 5s
            timeout: 5s
            retries: 6
            start_period: 10s
networks:
    keploy-net:
